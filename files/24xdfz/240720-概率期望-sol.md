## [ARC150D Removing Gacha](https://www.luogu.com.cn/problem/AT_arc150_d)

### 题面描述

给定一棵树，初始每个点都没被选中，以 $1$ 为根。

每次会选择一个点，满足**它或它的任意一个祖先未被选中**。如果这个点未被选中，就会选中该点。

求使所有点被选中的期望次数，对 $998244353$ 取模。

$ 2\ \leq\ N\ \leq\ 2\ \times\ 10^5,1\ \leq\ p_i\ <\ i $

### 题解

答案等于每个点被选的期望次数之和。

设点 $x$ 深度为 $d$。在 $x$ 祖先被选完之前 $x$ 会被多次选到。所以问题等价于 $d$ 个点，每次等概率选一个点直到所有点都被选过一次，选到点 $d$ 时答案加一。已经选了 $i$ 个点，选到 $i+1$ 期望要 $\frac{d}{d-i}$ 步。$ans=\sum_{i=0}^{d-1} \frac{d}{d-i}=d\sum_{i=1}^d \frac{1}{i}$。其中每一次选中特定一个点的概率为 $\frac{1}{d}$，所以每个点被选的期望次数为 $\sum_{i=1}^d \frac{1}{i}$。



## CF1540B Tree Array 

### 题目描述 

给定一棵 $n$ 个节点的树。  
对于这棵树，我们通过下列方法来生成一个序列：

1. 等概率选择这 $n$ 个节点中的一个节点，并对这个节点打上标记（初始时没有节点被打上标记）；
2. 在所有没被打上标记且与至少一个打上标记的节点相连的节点中等概率选择一个节点并对这个节点打上标记；
3. 重复步骤 2 直到所有节点都被打上标记，此时生成的序列就是所有节点编号按照节点被打上标记的时间排序后的形成的序列。

求生成序列的期望逆序对数对 $10^9+7$ 取模后的值。  
$2\leq n\leq200$。

### 题解

先枚举第一次选择的点，设为根。枚举 $u,v$，计算 $u,v$ 逆序的期望。由于只有两点到 $lca$ 路径上的点有关，所以可以看作有两个分别装着 $dep_u-dep_{lca}$ 和 $dep_v-dep_{lca}$ 个球的盒子，每次随机选一个扔掉，先扔光某一盒子的概率。$dp$ 预处理即可。



## [CF1267G Game Relics](https://www.luogu.com.cn/problem/CF1267G)

### 题面描述

现在有 $n$ 种圣物，其中第 $i$ 个圣物的价格为 $c_i$ 碎片。你想把这 $n$ 种圣物全买一遍，其中有两种购买方式：

- 花费 $c_i$ 碎片购买第 $i$ 种圣物。
- 花费 $x$ 碎片进行抽奖，可以等概率随机获得这 $n$ 种圣物中的一种，如果获得了已经获得过的圣物，则会还给你 $\frac{x}{2}$ 碎片。

现在求最优策略下，得到这 $n$ 种圣物的最小期望花费。

$n\le 100$，要求精度 $10^{-9}$。

### 题解

一定会先抽再买。已有 $i$ 张卡，通过抽卡期望花费 $(\frac{n}{n-i}-1)\times \frac{x}{2}+x$ 获得第 $i+1$ 张。考虑把所有直接购买的花费均摊到每次之中，设当前已有 $i$ 张，价值和为 $j$ ，通过买期望花费 $\frac{all-j}{n-i}$ 获得第 $i+1$ 张。

总期望等于每一种 已有 $i$ 张，价值和为 $j$  的情况的概率乘代价，概率等于方案数除以总方案数

01 背包求得出现 已有 $i$ 张，价值和为 $j$  的方案数，除以总方案数 $n$ 个选 $i$ 个 $\binom n 2$，得到 已有 $i$ 张，价值和为 $j$  的概率，乘以抽卡和买期望花费的较小值得到这种情况的期望，全部加起来得到总期望。



## CF1187F Expected Square Beauty 

### 题目描述 

有一个长度为 $n$ 的数列 $x_i$，定义 $B(x)$ 为将 $x$ 划分为所有元素都相等的子段的最小子段数。 对于 $1 \leq i \leq n$，$x_i$ 将等概率为 $[l_i,r_i]$ 中的一个整数。 给定 $l_i,r_i$，求 $(B(x))^2$ 的期望，即 $E((B(x))^2)$，对 $10^9+7$ 取模。 

$n \leq 2 \times 10^5,l_i,r_i \leq 10^9$。 

### 题解 

将 $B(x)$ 转化为 $\sum_{i=1}^{n-1}[x_i \ne x_{i+1}]$，则 $E((B(x))^2)$ 等于 $\sum_{i=1}^{n-1}\sum_{j=1}^{n-1}[x_i\ne x_{i+1}]\times[x_j\ne x_{j+1}]$，设 $R_i=E(x_i\ne x_{i+1})$，独立计算即可。



## [CF1265E Beautiful Mirrors](https://www.luogu.com.cn/problem/CF1265E)

### 题面描述

C 有 $n$ 面魔镜，每天她会问一面镜子：“我漂亮吗？”，第 $i$ 面镜子有 $\dfrac{p_i}{100}$（$1 \le p_i \le 100$）的概率告诉 C 她漂亮。

C 从第 $1$ 面镜子开始，每天询问一面镜子。对第 $i$ 面镜子，将会发生两种情况：

* 如果这面镜子告诉 C 她很漂亮：

  * 如果这是第 $n$ 面镜子，那么 C 将会十分开心，并且停止询问。
    * 反之，C 将在第二天询问第 $i+1$ 面镜子。

* 反之，C  将会十分伤心，第二天重新从询问第 $1$ 面镜子开始询问。

求 C 停止询问的期望天数，对 $998, 244, 353$ 取模。

$1 \le n \le 2 \cdot {10}^5$。

### 题解

从后往前 dp，设 $dp_i$ 表示当前在 $i$ 期望多久结束。$dp_i=p_idp_{i+1}+(1-p_i)dp_1+1$。转移成环，无法 dp。这种转移要利用式子的各种性质。

发现 $dp_1$ 是特殊的。$dp_1=p_1dp_2+(1-p_1)dp_1+1$，$dp_1=dp_2+\frac{1}{p_1}$。$dp_2=p_2dp_3+(1-p_2)dp_1+1$，$dp_1=dp_3+\frac{1}{p_2}+\frac{1}{p_1p_2}$。

递推发现 $dp_1=dp_{i+1}+\sum _{j=1}^i\prod_{k=i-j+1}^i \frac{1}{p_k}$。因为 $dp_{n+1}=0$，可直接写出 $dp_1$。



## ABC231G Balls in Boxes 

### 题目描述

 有 $n$ 个盒子，初始时第 $i$ 个盒子内有 $a_i$ 个小球，进行 $k$ 次操作后，每次操作等概率随机选择一个盒子放入一个小球，设 $k$ 次操作后每个盒子的小球个数为 $b_i$，那么得分为 $\prod_{i=1}^{n}b_i$。求出期望得分。 

$K,a_i \leq 10^9,n \leq 1000$。 

### 题解

将期望转为计数，考虑组合意义，把 $\prod_{i=1}^{n}b_i$ 看作每个盒子选一个小球的方案数。每次操作相当于在盒子中加入小球。设 $f_{i,j}$ 表示前 $i$ 个盒子中有 $j$ 个盒子选择了新加入的球的方案数，转移时选择一个未选择过的操作加入的球或者这个盒子本身的小球即可。  



## [CF1770E Koxia and Tree](https://www.luogu.com.cn/problem/CF1770E)

### 题面描述

有一棵 $n$ 个结点的无根树，边从 $1$ 到 $n-1$ 标号，第 $i$ 条边连接结点 $u_i$ 和 $v_i$。

有 $k$ 个结点带有标记，分别是 $a_1,a_2,\cdots,a_k$（$\forall i\not= j,a_i\not = a_j$）。接下来，进行如下操作：

1. 给每条边随机定向。
2. **按照编号顺序**，对于每一条边 $u\to v$，如果结点 $u$ 有标记而 $v$ 没有，那么就把 $u$ 的标记转移到 $v$ 上。
3. 随机选取两个不同的标记点，计算它们的距离。

你需要给出第三步中距离的期望值。对 998244353 取模。

 $ 2 \leq k \leq n \leq 3 \cdot {10}^5 $ 。

### 题解

转换为两两标记之和除以总方案数。再转换为每条边会被多少对标记跨越。记 $sum_u$ 表示 $u$ 子树内有多少标记。如果没有移动，答案为 $\frac{\sum sum_v(k-sum_v)}{\binom k 2}$。

$sum_u$ 至多变化 $1$。取决于 $u,v$ 上是否有标记的概率 $p_u,p_v$。当对 $(u,v)$ 操作时，$p_u,p_v$ 改变，分类讨论 $u,v$ 之前是否有标记更新 $p_u=p_v=p_up_v+\frac{(1-p_u)p_v}{2}+\frac{p_u(1-p_v)}{2}=\frac{p_u+p_v}{2}$。再分类讨论最后 $u,v$ 是否有标记，得到边 $(u,v)$ 的期望贡献为：

$$(p_up_v+(1-p_u)(1-p_v))sum_v(k-sum_v)+p_u(1-p_v)\frac{(sum_v+1)(k-sum_v-1)+sum_v(k-sum_v)}{2}+(1-p_u)p_v\frac{(sum_v-1)(k-sum_v+1)+sum_v(k-sum_v)}{2}$$



## CF1295F Good Contest 

### 题目描述 

$a_i$ 是在 $[l_i, r_i]$ 上均匀随机分布的整数，求 $a_{1 \dots n}$ 单调不增的概率。

$n\leq 50,l_i,r_i\leq 998244351$。 

### 题解 

先转为方案数，将值域离散化，分为 $m$ 个区间。设 $f_{i,j}$ 为确定前 $i$ 个数且 $a_i$ 在第 $j$ 个区间中的方案数，转移时有 $f_{i,j}$ 为 $\sum_{k\leq i} f_{i-1,k}$ 加上 $f_{i-1,j}$ 中符合条件的方案数。发现后一种情况不好算，于是枚举 $[i-k+1,i]$ 这 $k$ 个点都在第 $j$ 个区间范围内，组合数计算即可。