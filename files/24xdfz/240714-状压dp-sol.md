# P2150

给定 $n$，求选出集合 $S,T$ 的方案数，使得 $S,T\subseteq {2,3,4,\cdots,n}$ 且 $\not\exists x\in S,y\in T,\gcd(x,y)>1$。答案模 $p$。

$2\le n\le500,0<p\le 10^9$

先有一个暴力的想法：一个一个枚举每个数加进哪个集合或不加，对于两个集合，分别状压记录每个质因数是否被选中，转移。状态数是 $O(2^{\dfrac{2n}{\ln n}})$ 的（$\sum_{i\le n}[i\in P]\approx \dfrac{n}{\ln n}$）。显然过不了。

又有另一个想法：为什么不能将有同样质因数的数拿出来，钦定他们其中被选中的都在同一个集合呢？但是发现可能出现一种情况，就是这些数中存在一个更小的质因数 $p$，而 $p$ 这个质因数在另一个集合也出现了。

然后你就发现我们其实可以综合一下这两个做法。具体地，将每个数加进它最大的质因数所代表的集合。规定一个集合的数不同时出现在两个答案集合中。然后，为了避免上面所提到的问题，我们可以记录部分质因数。哪部分呢？实际上只用 $\le\sqrt n$ 的就行了，因为如果一个数有不止一个质因数，则其中至少有一个 $\le\sqrt n$，至多有一个 $>\sqrt n$。于是这么做就是正确的。

# ABC219H

在一条数轴上有 $N$ 支蜡烛，第 $i$ 支蜡烛长度为 $A_i$，且位于数轴上的 $X_i$ 处。

时刻 $0$ 时，$N$ 支蜡烛都被点燃。一根点燃的蜡烛每过一时刻就会减少 $1$ 的长度。当长度变为 $0$ 时蜡烛将会熄灭。熄灭的蜡烛的长度不会减少。

时刻 $0$ 时，你位于数轴上的 $0$ 处。一时刻中你可以在数轴上左右移动不超过 $1$ 的单位距离。当你到达某支蜡烛所在的位置时，你可以选择熄灭这支蜡烛，熄灭蜡烛的时间忽略不计。如果有多支蜡烛位于同一个位置，你可以一次性熄灭该位置上的所有蜡烛。

求时刻 $10^{100}$ 时最大的蜡烛总长度。

$1\leq N\leq300,-10^9\leq X_i\leq10^9,1\leq A_i\leq10^9$



首先考虑蜡烛可以烧到负数长度怎么做。发现这题等同于关路灯。设个状态：$dp_{i,j,0/1}$ 表示当前 $[i,j]$ 范围内的蜡烛都已熄灭，现在人在左/右端点的最大答案。枚举从 $[i+1,j]$ 或 $[i,j-1]$ 转移即可。

然后加入只能烧到 $0$ 长度怎么做。看起来变得非常麻烦，但是会发现一个性质：此时问题的答案不会比上面问题的答案更小。因为相对于上面的问题，此时长度 $<0$ 的蜡烛相当于是被我们删去了。

此时就可以将这个问题转化一下：你可以在这些蜡烛中选任意多个删去，并根据上面的方式计算，并将所有结果取 $\max$。**因为在最优情况中，有正贡献的蜡烛一定会被选，否则一定不会。所以这两个问题是等价的。**

所以可以直接把选了多少个塞进状态。设 $dp_{i,j,k,0/1}$ 表示当前 $[i,j]$ 范围内的蜡烛都已熄灭，还有 $k$ 个蜡烛会产生贡献，现在人在左/右端点的最大答案。枚举从 $[i+1,j]$ 或 $[i,j-1]$ 转移及当前蜡烛有没有被删去即可。时间复杂度 $O(n^3)$。

# CF79D

你有 $n$ 个灯泡，一开始都未点亮。

同时你有 $l$ 个长度，分别为 $a_1 \sim a_l$。

每次你可以选择一段连续的子序列，且长度为某个 $a_i$，并将这些灯泡的明灭状态取反。

求最少的操作次数，使得最后有且仅有 $k$ 个位置是亮的，这些位置已经给定，为 $x_1 \sim x_k$。

$1\le n\le10^4,1\le k\le 10,1\le l\le100$



下文 $1$ 表示亮，$0$ 表示不亮。

首先，操作到一个固定状态显然是比操作回全 $0$ 难做的。于是把操作逆过来。

如果我们直接按题目说的，区间反转入手，容易发现 $1$ 的个数大概率是越来越多的。怎么办呢？因为是区间操作，又是异或，于是想到将区间修改**差分**。

设 $b_i=a_i\oplus a_{i-1}$，问题就转换成：每次可以将 $b_i,b_{i+x_j}(i+x_j\le n+1)$ 两个位置异或上 $1$，问最少多少次操作后 $\forall i\in[1,n],b_i=0$。

考虑怎么解决一个问题。先思考：我们会凭空对两个为 $0$ 的位置操作吗？显然是**不会**的。但是又有一个问题：为什么不能用这次操作完产生的 $1$ 和其他位置再操作呢？这是因为差分操作可以无视顺序，所以交换顺序后，**一定满足每次操作至少有一个位置的 $b_i=1$。**

好的，现在这个问题已经被简单化很多了，但是两个位置同时异或 $1$ 这个操作仍然不好表示，于是考虑再把这个操作做一个转化。

考虑如果操作 $i,j$ 两个位置，$b_i=1,b_j=0$，可以怎么刻画呢？发现其实可以视作 $i$ 上的 $1$ **移动到**了 $j$。如果两者都是 $1$ 呢？就可以视作 $i$ 上的 $1$ 移动到 $j$，并且和 $j$ 上的 $1$ 抵消了。

于是，我们可以**将一次操作视为一个 $1$ 在一张图上走了一步**，要求最后每个点都能匹配上另一个点，使它们最后在同一个位置，或者这个点在 $n+1$ 号点。

由于 $\sum[b_i=1]\le2\times k\le20$，于是直接考虑状压 dp。预处理出 $i,j$ 位置上的 $1$ 最少需要几步相遇，然后每次枚举两个为 $1$ 的位置转移，最后加上移动到 $n+1$ 的贡献即可。

# GalaxyOJ 9134

Generals 打麻将被抓到包了，于是 fsj 取出了 $n$ 张麻将，其中可能有正面朝上的（记作 $1$）和反面朝上的（记作 $0$）并把它们排成一列，记作一个字符串 $S$。

现在 fsj 给了 Generals 一个整数 $m$，他要求 Generals 操作麻将使得 $S$ 满足 $S_1=S_{m+1},S_2=S_{m+2},\cdots,S_{n-m}=S_n$，即前 $n-m$ 张麻将和后 $n-m$ 张对应相同。

Generals 有两种操作方式：

- Generals 自己动手，将一张麻将翻转。

- Generals 利用他的牌尺（假设有无限多个），每个牌尺恰好长为 $m$，他可以同时用任意多个牌尺（设用 $k$ 个），将前 $k\times m$ 张麻将翻转。

请你帮帮 Generals 用最少的操作次数完成，否则它就会被 fsj 击飞然后破产。

$1\le m\le n\le 300$

tips：$1\le n\le10$



首先考虑一些简单的情况，比如 $m=1$。

容易发现操作 1 和操作 2 的顺序不会影响结果，于是可以钦定所有操作 1 在操作 2 之前。并且可以发现，进行完所有 1 后 2 的次数即为 $(\text{连续段个数}-1)$。

然后考虑将 $m>1$ 的情况。显然最后序列上每 $m$ 长度分一段，则每一段都相同，最后一段例外，是和其他段的一段等长前缀相同。那么设最后每段都为 $S$，一开始每段的状态为 $A_i$，则在所有操作 2 之前，都有 $S=A_i$ 或 $S=flip(A_i)$。$flip(X)$ 表示把 $X$ 串内所有数 $\oplus 1$。然后定义一个序列 $c_i$ 表示第 $i$ 段有没有被 $flip$。则与 $m=1$ 时一样，需要进行操作 2 的次数即为 $c$ 的连续段个数。

此时注意到到 $m$ 长度一段，就共有 $\left\lceil\dfrac{n}{m}\right\rceil$ 段，联系 $n\leq300$，发现 $\sqrt n\leq20$。于是考虑根号分治。

- $m\leq\sqrt n$

则上文的 $S$ 长度 $\leq 20$。暴力状压 $S$，对于每一种 $S$，考虑 dp。设 $dp_{i,0/1}$ 为当前处理到第 $i$ 段，有没有翻转的最小操作数。则有：

$$dp_{i,j}=\min(dp_{i-1,j}+\operatorname{popcount}(S\oplus c_i\oplus(j\times (2^m-1)),dp_{i-1,j\oplus 1}+\operatorname{popcount}(S\oplus c_i\oplus(j\times (2^m-1)))+1)$$

其中 $(j\times (2^m-1))$ 部分是要看这一段是否翻转，$+1$ 则是因为新增连续段。

初始状态为 $dp_{0,0}=0$

最后一个不完整的段要特殊处理，差别不大。

- $m>\sqrt n$

则段数 $\leq 20$。暴力状压 $c$，然后处理 $S$。根据 $S$ 当前位 $0/1$ 的数量，贪心地选择更小的，再加上操作 2 次数。全部取最小值即为答案。

时间复杂度 $O(2^{\sqrt n}\times n)$。

## [P9902 『PG2』模拟最大流](https://www.luogu.com.cn/problem/P9902)

### 题目描述

给定 $n$ 个点，$m$ 条有向边，给定每条边的容量，保证每条边 $(u,v,w)$ 满足 $v-u\in[0,k]$，求从点 $1$ 到点 $n$ 的最大流。

$2\leq n\leq 8\times 10^4$，$1\leq m\leq 10^6$，$2\leq k\leq 7$，$1\leq w\leq100$。



### 题解

最大流转最小割。利用性质 $v-u\in[0,k]$ 状压。

最小割满足 $S\to i$ 或 $i\to T$。如果有 $S\to j$ 且有 $j\to i$，要么有 $S\to i$ 或花费 $\sum w(j,i)$ 代价断开所有 $j\to i$ 且 $i\to T$。状压 $dp_{i,s}$ 表示前 $i$ 个点且 $S$ 与 $[i-k+1,i]$ 是否连通的状态为 $s$ 的最小割代价。转移时讨论 $i+1$ 是否与 $S$ 连通。复杂度 $O(nk2^k)$。



---

## [CF1383C String Transformation 2](https://www.luogu.com.cn/problem/CF1383C)

### 题目描述

给定两个字符串 $A$ 和 $B$，每次可以选取 $A$ 中**若干个**相同的字符 $x$，然后将其改成 $y$

求使得 $A=B$ 的最小操作次数。

$\sum |A|,\sum |B|\le 10^5$，$A$ 和 $B$ 仅由 ```a``` $\sim$ ```t``` 构成。



### 题解

建图，每个字母作为节点，按操作的时间顺序连边。若 $a_i\neq b_i$ 就要求存在 $a_i\to b_i$ 的时间单调上升的路径。

进行观察。 $i\to j,i\to k$ 劣于 $i\to j,j\to k$。所以答案形如链加若干条从链下方向上连的返祖边。把返祖边直接连到链顶，这样每个点至多一条返祖边。答案相当于每个点 $2$ 条边的贡献减去最大的不会返祖的集合大小。状压合法点集，枚举新加的点。复杂度 $O(2^cc)$。



---

## [P6192 【模板】最小斯坦纳树](https://www.luogu.com.cn/problem/P6192)

### 题目描述

 $n$ 个点和 $m$ 条边的无向连通图和 $k$ 个关键点。求包含所有关键点且边权最小的连通的子图。

$1\leq n\leq 100,\ \ 1\leq m\leq 500,k\le 10$。



### 题解

答案一定是树。设 $dp_{i,s}$ 表示 $i$ 为树根，包含关键点集合 $s$ 的最小代价。考虑转移。

- 换根。$dp_{j,s}+w(i,j)\to dp_{i,s}$。
- 划分子集。$dp_{i,s1}+dp_{i,s2}\to dp_{i,s}$。

注意到错解不优。顺序先枚举 $s$，转移先二后一。

第一个转移相当于最短路，复杂度 $O(m\log m2^k)$。第二个转移枚举子集，复杂度 $O(n3^k)$。



---

## [P4590 [TJOI2018] 游园会](https://www.luogu.com.cn/problem/P4590)

### 题目描述

给定一个长度为 $k$、字符集大小为 $3$ 的字符串 $S$，对于 $i\in [0,k]$，求有多少个长度为 $n$ 且不包含子串 ```abc``` 的字符串 $T$ 满足 $S$,$T$ 的最长公共字串长度为 $i$。

$N\leq1000,K\leq15$。



### 题解

考虑设计一个字符串状态 $s$，设 $dp_{i,s}$ 表示前 $i$ 位，字符串状态为 $s$ 的方案数。转移时枚举下一个字符去到下一个状态。

先可以用状态 $j=0/1/2$ 表示当前字符串匹配 ```abc``` 的长度。还需要一个状态表示与 $S$ 的匹配长度。

可以用 $f_{i,j}=\max(f_{i-1,j},f_{i,j-1},f_{i-1,j-1}+(T_i=S_j))$ 来转移匹配长度。只需要知道 $f_{i-1}$ 和 $T_i$ 就可以转移。因为 $f_{i-1}$ 单调递增且每次增量为 $0/1$，所以状压 $f_{i-1}$ 的差分数组只有至多 $2^k$ 种状态。于是 $f_{i-1}$ 差分状态 $s$ 作为 $dp_{i,j,s}$ 的一维。加入 $T_i$ 时将 $s$ 前缀和还原进行 $f_i$ 的计算再差分压缩。复杂度 $O(n2^k)$。